services:
  # Streamlit Web Application
  webapp:
    build:
      context: ./web_app
      dockerfile: Dockerfile
    container_name: sc_webapp
    ports:
      - "8501:8501"
    environment:
      - SPARK_MASTER=spark://spark-master:7077
    volumes:
      - ./data:/app/data
    networks:
      - sc_network

  # Apache Spark Cluster
  spark-master:
    image: apache/spark:3.5.0
    container_name: sc_spark_master
    ports:
      - "7077:7077"
      - "8081:8080"  # Changed external port to 8081
    command: >
      /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
      --host spark-master
      --port 7077
      --webui-port 8080
    environment:
      - SPARK_LOCAL_IP=spark-master
    volumes:
      - ./pipelines/spark_jobs:/app
      - ./data:/data
    networks:
      - sc_network

  spark-worker:
    image: apache/spark:3.5.0
    container_name: sc_spark_worker
    depends_on:
      - spark-master
    command: >
      /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker
      spark://spark-master:7077
      --webui-port 8082
    environment:
      - SPARK_LOCAL_IP=spark-worker
      - SPARK_WORKER_CORES=2
      - SPARK_WORKER_MEMORY=2g
    volumes:
      - ./pipelines/spark_jobs:/app
      - ./data:/data
    networks:
      - sc_network

  # Apache NiFi for workflow orchestration
  nifi:
    image: apache/nifi:1.23.0
    container_name: sc_nifi
    ports:
      - "8080:8080"  # NiFi keeps port 8080
    environment:
      - NIFI_WEB_HTTP_PORT=8080
      - NIFI_WEB_HTTP_HOST=0.0.0.0
    volumes:
      - ./data:/data
    networks:
      - sc_network

networks:
  sc_network:
    driver: bridge

